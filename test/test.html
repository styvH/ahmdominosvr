<head>
    <meta charset="utf-8">
    <title>KISA DOMINO</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-extras/dist/aframe-extras.min.js"></script>
</head>
<body>
    <a-scene>
        <!-- Préchargement des textures -->
        <a-assets>
          <!-- Textures uniques pour chaque domino -->
          <img id="D1" name="0-0" src="../img/domino-00.png" crossorigin="anonymous">
          <img id="D2" name="0-1" src="https://cdn.pixabay.com/photo/2012/04/14/15/57/domino-34381_1280.png" crossorigin="anonymous">
          <img id="D3" name="0-2" src="https://cdn.pixabay.com/photo/2012/04/14/15/58/domino-34382_1280.png" crossorigin="anonymous">
          <img id="D4" name="0-3" src="https://cdn.pixabay.com/photo/2012/04/14/15/58/domino-34383_1280.png" crossorigin="anonymous">
          <img id="D5" name="0-4" src="https://cdn.pixabay.com/photo/2012/04/14/15/58/domino-34384_1280.png" crossorigin="anonymous">
          <img id="D6" name="0-5" src="https://cdn.pixabay.com/photo/2012/04/14/15/58/domino-34385_1280.png" crossorigin="anonymous">
          <img id="D7" name="0-6" src="https://cdn.pixabay.com/photo/2012/04/14/15/58/domino-34386_1280.png" crossorigin="anonymous">
          
          <img id="D8" name="1-1" src="https://cdn.pixabay.com/photo/2012/04/14/15/58/domino-34387_1280.png" crossorigin="anonymous">          
          <img id="D9" name="1-2" src="https://cdn.pixabay.com/photo/2012/04/14/15/58/domino-34388_1280.png" crossorigin="anonymous">
          <img id="D10" name="1-3" src="https://cdn.pixabay.com/photo/2012/04/14/15/58/dominoes-34389_1280.png" crossorigin="anonymous">
          <img id="D11" name="1-4" src="https://cdn.pixabay.com/photo/2012/04/14/15/58/domino-34390_1280.png" crossorigin="anonymous">
          <img id="D12" name="1-5" src="https://cdn.pixabay.com/photo/2012/04/14/15/58/domino-34391_1280.png" crossorigin="anonymous">
          <img id="D13" name="1-6" src="https://cdn.pixabay.com/photo/2012/04/14/15/58/domino-34392_1280.png" crossorigin="anonymous">
          
          
          <img id="D14" name="2-2" src="https://cdn.pixabay.com/photo/2012/04/14/15/59/domino-34393_1280.png" crossorigin="anonymous">
          <img id="D15" name="2-3" src="https://cdn.pixabay.com/photo/2012/04/14/15/59/domino-34394_1280.png" crossorigin="anonymous">
          <img id="D16" name="2-4" src="https://cdn.pixabay.com/photo/2012/04/14/15/59/domino-34395_1280.png" crossorigin="anonymous">
          <img id="D17" name="2-5" src="https://cdn.pixabay.com/photo/2012/04/14/15/59/domino-34396_1280.png" crossorigin="anonymous">     
          <img id="D18" name="2-6" src="https://cdn.pixabay.com/photo/2012/04/14/15/59/domino-34397_1280.png" crossorigin="anonymous">
         
          <img id="D19" name="3-3" src="https://cdn.pixabay.com/photo/2012/04/14/15/59/domino-34398_1280.png" crossorigin="anonymous">
          <img id="D20" name="3-4" src="https://cdn.pixabay.com/photo/2012/04/14/15/59/domino-34399_1280.png" crossorigin="anonymous">
          <img id="D21" name="3-5" src="https://cdn.pixabay.com/photo/2012/04/14/15/59/domino-34400_1280.png" crossorigin="anonymous">
          <img id="D22" name="3-6" src="https://cdn.pixabay.com/photo/2012/04/14/15/59/domino-34401_1280.png" crossorigin="anonymous">
          
          <img id="D23" name="4-4" src="https://cdn.pixabay.com/photo/2012/04/14/15/59/domino-34402_1280.png" crossorigin="anonymous">
          <img id="D24" name="4-5" src="https://cdn.pixabay.com/photo/2012/04/14/16/00/domino-34403_1280.png" crossorigin="anonymous">
          <img id="D25" name="4-6" src="https://cdn.pixabay.com/photo/2012/04/14/16/00/domino-34404_1280.png" crossorigin="anonymous">
          
          <img id="D26" name="5-5" src="https://cdn.pixabay.com/photo/2012/04/14/16/00/dominoes-34405_1280.png" crossorigin="anonymous">
          <img id="D27" name="5-6" src="https://cdn.pixabay.com/photo/2012/05/07/11/07/domino-48089_1280.png" crossorigin="anonymous">

          <img id="D28" name="6-6" src="https://cdn.pixabay.com/photo/2012/04/14/16/00/domino-34407_1280.png" crossorigin="anonymous">
      </a-assets>
            <a-camera
            position="0 2.5 11"
            rotation="0 0 0"
            laser-controls
            hand-model="../img/domino"
            ></a-camera>
        

        <!-- Ciel pour contexte -->
        <a-sky color="#ECECEC"></a-sky>

        <!-- Table pour contexte -->
        <a-plane position="0 0 0" rotation="-90 0 0" width="30" height="30" color="#8B4513"></a-plane>

        <script>
          // Fonction pour créer un domino avec espacement et texture spécifique
          function createDomino(position, rotation, textureId) {
            // Conteneur pour le domino
            let dominoContainer = document.createElement('a-entity');
            dominoContainer.setAttribute('position', position);
            dominoContainer.setAttribute('rotation', rotation);

            // Corps du domino
            let dominoBody = document.createElement('a-box');
            dominoBody.setAttribute('width', '1');
            dominoBody.setAttribute('height', '1');
            dominoBody.setAttribute('depth', '0.2');
            dominoBody.setAttribute('color', '#FFF'); // Couleur de fond du domino

            // Face avec texture
            let dominoFace = document.createElement('a-plane');
            dominoFace.setAttribute('position', '0 0 0.105'); // Ajuster pour éviter le z-fighting
            dominoFace.setAttribute('width', '1');
            dominoFace.setAttribute('height', '1');
            dominoFace.setAttribute('material', `src: #${textureId}`);

            // Ajout du corps et de la face au conteneur
            dominoContainer.appendChild(dominoBody);
            dominoContainer.appendChild(dominoFace);
            
            // Affectation de l'appel à la fonction onClick à l'élément crée
            dominoContainer.addEventListener('click', () => selectAndPlaceDomino(dominoContainer));

            // Ajout du conteneur à la scène
            document.querySelector('a-scene').appendChild(dominoContainer);
        }

          // Positions ajustées pour les dominos
          let distanceX = 7; // Pour les dominos à droite et à gauche
          let distanceZ = 7; // Pour les dominos devant et derrière
          let spacing = 1.1; // Largeur du domino (1m) + espace de 10cm

          // Génération des dominos avec des textures uniques et orientation correcte
          for (let i = 0; i < 7; i++) {
              let positionZRightLeft = i * spacing - 3 * spacing; // Ajustement pour l'espacement
              let positionXFrontBack = i * spacing - 3 * spacing; // Ajustement pour l'espacement

              // Dominos à droite (doivent être orientés de 90 degrés pour faire face au centre)
              createDomino(`${distanceX} 0.5 ${positionZRightLeft}`, '0 90 0', `D${i+1}`);
              // Dominos à gauche (doivent être orientés de -90 degrés pour faire face au centre)
              createDomino(`${-distanceX} 0.5 ${positionZRightLeft}`, '0 -90 0', `D${i+8}`);
              
              // Dominos devant (doivent être orientés de 0 degré pour faire face au centre)
              createDomino(`${positionXFrontBack} 0.5 ${distanceZ}`, '0 0 0', `D${i+15}`);
              // Dominos derrière (doivent être orientés de 180 degrés pour faire face au centre)
              createDomino(`${positionXFrontBack} 0.5 ${-distanceZ}`, '0 180 0', `D${i+22}`);
          }

          // Référence au gestionnaire de laser
const laserManager = document.querySelector('[laser-controls]').components['laser-controls'];

// Objet actuellement sélectionné
let selectedObject = null;

// Variable pour suivre l'état du placement (premier ou second clic)
let placingState = false;

// Écouteurs d'événements pour le laser
laserManager.system.addEventListener('selectstart', onSelectStart);
laserManager.system.addEventListener('selectend', onSelectEnd);

function onSelectStart() {
  if (!selectedObject || !placingState) return;
  
  // Désactive le rendu de l'objet lorsqu'il est saisi
  selectedObject.object3D.visible = false;
}

function onSelectEnd() {
  if (!selectedObject || !placingState) return;
  
  // Active le rendu de l'objet après son relâchement
  selectedObject.object3D.visible = true;

  // Place l'objet sur le sol
  const plane = new THREE.Plane().setFromNormalAndCoplanarPoint(new THREE.Vector3(0, 1, 0), new THREE.Vector3());
  const intersection = new THREE.Vector3();
  const raycaster = new THREE.Raycaster();
  
  raycaster.ray.origin.copy(selectedObject.object3D.getWorldPosition(new THREE.Vector3()));
  raycaster.ray.direction.copy(selectedObject.object3D.getWorldDirection(new THREE.Vector3()));
  const intersects = raycaster.intersectObjects([document.querySelector('a-plane')], true);

  if (intersects.length > 0) {
    intersection.copy(intersects[0].point);
    intersection.applyMatrix4(selectedObject.object3D.matrixWorld);
    
    selectedObject.object3D.position.copy(intersection);
    selectedObject.object3D.rotation.set(Math.PI / 2, 0, Math.atan2(-selectedObject.object3D.right.x, -selectedObject.object3D.up.y));
  }

  // Réinitialisation de l'état du placement
  placingState = false;
  selectedObject = null;
}



function selectAndPlaceDomino(dominoContainer) {
  // Si un objet est déjà sélectionné, annuler la dernière sélection
  if (selectedObject) {
    deselectObject(selectedObject);
  }

  selectingObject = dominoContainer;
  placingState = true;
}

function deselectObject(object) {
  object.removeEventListener('click', selectAndPlaceDomino);
  object.object3D.visible = true;
  object = null;
}
        </script>
    </a-scene>
</body>
